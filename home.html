<!DOCTYPE html>

<html>
    <head>
        <style id="rowStyle">table, th, td {border:1px solid black;} th { padding: 20px;} table.center {margin-left: auto; margin-right: auto;} table {text-align: center;}</style>
    </head>
    <body>
        <button id="login" onclick="window.location.href = 'login.html'">Want to Login?</button>
        <h1 id="track"></h1>
        <table id="table">
            <tr id="Winner">
                <td><h4 style="color: #000;" id="posW"></h4></td>
                <td><h4 id="tBrandW"></h4></td>
                <td><h4 id="tTypeW"></h4></td>
                <td><h4 id="cColorW"></h4></td>
                <td><h4 id="cBodyW"></h4></td>
                <td><h4 id="chanceW"></h4></td>
            </tr>
            <tr>
                <th><h3>Car #</h3></th>
                <th><h3>Tire Brand</h3></th>
                <th><h3>Tire Type</h3></th>
                <th><h3>Color</h3></th>
                <th><h3>Body Type</h3></th>
                <th><h3>Chance</h3></th>
            </tr>
        </table>

        <button id="race"><p>Press me to race!</p></button>
	<button id="generateCSV">Generate Race History(CSV)</button>

        <script>
            function Race() {
                const tracks = ["Sand", "Dirt", "Gravel", "Tarmac", "Brick", "Ice"];
                const trackNum = Math.floor(Math.random()*tracks.length);
                document.getElementById("track").innerHTML = tracks[trackNum];

                const tires = ["Michelin", "Goodyear", "Firestone", "Continental", "Bridgestone"];
                const tireChance = [0.97, 0.87, 0.78, 0.95, 0.56];

			    const tireTypes = ["All-Terrain", "Summer", "Winter", "All-Season", "Drag"];
                const tirePenalty = [[0.05, 0.05, 0.05, 0.05, 0.05, 0.05],
                                     [0.2, 0.15, 0.2, 0.05, 0.1, 0.3],
                                     [0.15, 0.1, 0.15, 0.05, 0.1, 0.1],
                                     [0.2, 0.15, 0.2, 0.05, 0.1, 0.15],
                                     [0.3, 0.25, 0.3, 0, 0.2, 0.3]];

                const colors = ["Red", "Blue", "Green", "Yellow", "Fuchsia", "Orange", "Teal", "Black"];
                const hexColors = ["#DD2222", "#2222DD", "#22DD22", "#DDDD22", "#DD22DD", "#DD9922", "#22DDDD", "#000000"];
                const colorChance = [1, 0.84, 0.74, 0.56, 0.86, 0.88, 0.69, 0.95];

                const bodies = ["Sport", "Muscle", "Sedan", "Truck", "SUV"];
                const bodyChance = [0.97, 0.85, 0.92, 0.50, 0.73];

                class Car {
                    constructor() {
                        const tireNum = Math.floor(Math.random()*tires.length);
                        this.tire = tires[tireNum];
                        const tTypeNum = Math.floor(Math.random()*tireTypes.length);
                        this.tireType = tireTypes[tTypeNum];
                        const colorNum = Math.floor(Math.random()*colors.length);
                        this.color = colors[colorNum];
                        this.hexColor = hexColors[colorNum];
                        const bodyNum = Math.floor(Math.random()*bodies.length);
                        this.body = bodies[bodyNum];
                        this.chance = (tireChance[tireNum]  - tirePenalty[tireNum][tTypeNum]) * colorChance[colorNum] * bodyChance[bodyNum];
                        this.chance = Math.floor(this.chance*100)/100;
                        this.position = 0;
                    }
                }

                var winner = new Car();
                winner.chance = 0;

		var raceResults = []; // Store race results

                var table = document.getElementById("table");

                for(var i = 0; i < 10; i++) {
                    const car = new Car();
                    var newRow = table.insertRow();
                    newRow.style.color = car.hexColor;
                    car.position = i + 1;

                    var firstCol = newRow.insertCell();
                    firstCol.innerHTML = "Car" + (i + 1);
                    firstCol.style = "padding: 20px;";
                    firstCol.style.color = "#000";
                    newRow.insertCell().innerHTML = car.tire;
                    newRow.insertCell().innerHTML = car.tireType;
                    newRow.insertCell().innerHTML = car.color;
                    newRow.insertCell().innerHTML = car.body;
                    newRow.insertCell().innerHTML = car.chance;

                    if(winner.chance < car.chance) {
                        winner = car;
                    }
			// Push car data to the race resultsa array
			raceResults.push([car.tire, car.tireType, car.color, car.body, car.chance]);
			
                }

                document.getElementById("tBrandW").innerHTML = winner.tire;
                document.getElementById("tTypeW").innerHTML = winner.tireType;
                document.getElementById("cColorW").innerHTML = winner.color;
                document.getElementById("cBodyW").innerHTML = winner.body;
                document.getElementById("chanceW").innerHTML = winner.chance;
                document.getElementById("Winner").style.color = winner.hexColor;
                document.getElementById("posW").innerHTML = "W Car " + winner.position;

		return raceResults; // return the array storing the results of the race
            }
		
       // Race();	
	function generateCSV() {
		var raceResults = Race(); // Get race results
		var csvContent = "data:text/csv;charset=utf-8,";

		raceResults.forEach(function(rowArray)  {
			var row = rowArray.join(",");
			csvContent += row + "\r\n";
		});

		return csvContent;
	}
        
          document.getElementById("race").addEventListener("click", () => {
            var table = document.getElementById("table");
            for(var i = 0; i < 10; i++) {
                table.deleteRow(-1);
            }
            Race();
        });

	document.getElementById("generateCSV").addEventListener("click", () => {
            var csvData = generateCSV();
            var encodedUri = encodeURI(csvData);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "raceHistory.csv");
            document.body.appendChild(link);
            link.click();
        });
        </script>
    </body>
</html>
